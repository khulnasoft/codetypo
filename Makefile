DICTIONARIES = codetypo/data/dictionary*.txt codetypo/tests/data/*.wordlist

PHONY := all check check-dictionaries sort-dictionaries trim-dictionaries check-dist pytest pypi ruff clean

GENERATED := codetypo/data/dictionary_en_to_en-OX_AUTOGENERATED.txt

all: $(GENERATED) check-dictionaries codespell.1

check: $(GENERATED) check-dictionaries check-dist pytest ruff

$(GENERATED): codetypo/data/dictionary_en-GB_to_en-US.txt ./tools/normalize_spelling.sh
	./tools/normalize_spelling.sh codetypo/data/dictionary_en-GB_to_en-US.txt > codetypo/data/dictionary_en_to_en-OX_AUTOGENERATED.txt

codetypo.1: codetypo.1.include Makefile
	PYTHONPATH=. help2man codetypo --include codetypo.1.include --no-info --output codetypo.1
	sed -i '/\.SS \"Usage/,+2d' codetypo.1

check-dictionaries: sort-dictionaries
	@for dictionary in ${DICTIONARIES}; do \
		if grep -E -n "^\s*$$|\s$$|^\s" $$dictionary; then \
			echo "Dictionary $$dictionary contains leading/trailing whitespace and/or blank lines.  Trim with 'make trim-dictionaries'"; \
			exit 1; \
		fi; \
	done
	@if command -v pytest > /dev/null; then \
		pytest codetypo/tests/test_dictionary.py; \
	else \
		echo "Test dependencies not present, install using 'pip install -e \".[dev]\"'"; \
		exit 1; \
	fi

sort-dictionaries: $(GENERATED)
	pre-commit run --all-files file-contents-sorter

trim-dictionaries: $(GENERATED)
	@for dictionary in ${DICTIONARIES}; do \
		sed -E -i.bak -e 's/^[[:space:]]+//; s/[[:space:]]+$$//; /^$$/d' $$dictionary && rm $$dictionary.bak; \
	done

check-dist:
	$(eval TMP := $(shell mktemp -d))
	python -m build -o $(TMP)
	twine check --strict $(TMP)/*
	rm -rf $(TMP)

ruff:
	pre-commit run --all-files ruff

pytest: sort-dictionaries
	@if command -v pytest > /dev/null; then \
		pytest codetypo; \
	else \
		echo "Test dependencies not present, install using 'pip install -e \".[dev]\"'"; \
		exit 1; \
	fi

clean:
	rm -rf codetypo.1

mypy:
	mypy .
